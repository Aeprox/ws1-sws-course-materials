<!doctype html>  
<html lang="en">
	
	<head>
		<meta charset="utf-8">
		
		<title>Webscripting1 &mdash; Serverside Webscripting &mdash; 07.databases</title>

		<meta name="description" content="Webscripting1 &mdash; Serverside Webscripting &mdash; 07.databases">
		<meta name="author" content="Bram(us) Van Damme - ikdoeict.be">
		
		<link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
		
		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/main.css" media="screen">
		<link rel="stylesheet" href="css/print.css" media="print">

		<link rel="stylesheet" href="lib/zenburn.css">

		<style>
			.columns .column {
				float: left;
				list-style: none;
				margin: 0 0 12px 0;
				padding: 0;
			}

			.column-12 {
				width: 50%;
				text-align: center;
			}
			code {
				color: gainsboro;
			}

			li > code, li em > code, li del > code, li ins > code, p > code {
				background: #3F3F3F;
				padding: 2px 4px;
				box-shadow: 0px 0px 6px rgba(0,0,0,0.3);
				font-size: 80%;
			}

			strong {
				color: #553d00;
				background: transparent url('assets/02/strong.png') no-repeat 50% 50%;
				font-size: 80%;
				padding: 0 4px;
				font-family: palatino, times;
				font-weight: 300;
				font-style: italic;
			}

			#reveal section img.noborder {
				background: transparent;
				border: 0;
				-webkit-box-shadow: none;
				-moz-box-shadow: none;
				-ms-box-shadow: none;
				-o-box-shadow: none;
				box-shadow: none;"
			}

			figure.zoomable-20:hover {
				-moz-transform: scale(2);
				-o-transform: scale(2);
				-webkit-transform: scale(2);
				transform: scale(2);
			}
		</style>

		<script type="text/javascript">

		  var _gaq = _gaq || [];
		  _gaq.push(['_setAccount', 'UA-107008-28']);
		  _gaq.push(['_trackPageview']);

		  (function() {
		    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		  })();

		</script>
	</head>
	
	<body>
		
		<div id="reveal">
			
			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">


				<!-- 0 : Title -->
				<section>

					<section>
						<h3 class="inverted">Serverside Webscripting <small>[JLW274]</small></h3>
						<h1>07.databases</h1>
					
						<footer>
							<em><a href="http://www.ikdoeict.be/">ikdoeict.be</a> &mdash; <a href="mailto:bramus.vandamme@kahosl.be">bramus.vandamme@kahosl.be</a></em>
						</footer>
						<script>
							// Delicously hacky. Look away.
							if( navigator.userAgent.match( /(iPhone|iPad|iPod|Android)/i ) )
							document.write( '<p style="color: rgba(0,0,0,0.3); text-shadow: none;">('+'Tap to navigate'+')</p>' );
						</script>
					</section>

				</section>




				<section>

					<section>
						<h2>Intro</h2>
					</section>

					<section>
						<h2>Choose your flavor</h2>

						<ul>
							<li class="fragment">
								Connecting to a database server from PHP possible by means of an extension
							</li>
							<li class="fragment">
								Extensions are available for most database servers
								<ul>
									<li class="fragment">MySQL, MS SQL, Oracle, &hellip;</li>
								</ul>
							</li>
							<li class="fragment">
								To connect to a MySQL server, 3 extensions exist
								<ul>
									<li class="fragment"><code>mysql</code> &mdash; Classic extension, procedural (= based on methods)</li>
									<li class="fragment"><code>mysql</code> &mdash; Improved version of the <code>mysql</code> extension. Supports Prepared Statements, Multiple Statements, Transactions, etc. Both OO and procedural</li>
									<li class="fragment"><code>pdo_mysql</code> &mdash; OO based; Implements PHP Data Objects, an interface to communicating with a database server.</li>
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>We'll choose</h2>

						<ul>
							<li class="fragment">
								DBMS? MySQL
								<ul>
									<li class="fragment">We've already worked with this</li>
									<li class="fragment">Free</li>
								</ul>
							</li>
							<li class="fragment">
								Extension? <code>mysqli</code>
								<ul>
									<li>Better than <code>mysql</code></li>
									<li><code>pdo_mysql</code> a tad above our level, for now</li>
								</ul>
							</li>
							<li class="fragment">
								OO or procedural? Procedural
								<ul>
									<li class="fragment">Most examples online are <code>mysql</code> based. Changing to the <code>mysqli</code> version is only a matter of changing the prefix of the function</li>
									<li class="fragment">If you know how to work procedural, and understand OO well, it's a very small step towards the OO version</li>
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>Activating mysqli</h2>

						<ul>
							<li class="fragment">
								Activate via <code>php.ini</code>
								<ul>
									<li class="fragment">
										Remove the leading <code>;</code> to activate<br />
										<div style="text-align: center;"><figure><img src="assets/07/phpini.jpg" alt="" title="" /></figure></div>
									</li>
									<li class="fragment">Already activated in Wampserver</li>
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>Verify activation</h2>

						<ul>
							<li class="fragment">
								Use <code>phpinfo()</code> and check if <code>mysqli</code> appears on the page<br />
							</li>
						</ul>
						<div style="text-align: center;" class="fragment"><figure><img src="assets/07/phpinfo.jpg" alt="" title="" width="500" /></figure></div>
					</section>


				</section>




				<section>

					<section>
						<h2>Connecting &amp; Disconnecting</h2>
					</section>

					<section>
						<h2>First of all</h2>

						<ul>
							<li class="fragment">
								We use a <code>config.php</code> to store our credentials in

								<pre class="bigger"><code class="language-php">&lt;?php
	
		define('DB_HOST', 'localhost');
		define('DB_USER', 'root');
		define('DB_PASS', 'Azerty123');
	
		define('DB_NAME_FF', 'fotofactory');
		define('DB_NAME_STATUS', 'status');

//EOF</code></pre>
							</li>
							<li class="fragment">Edit the file if needed (location: <code>/assets/07/examples</code>)</li>
							<li class="fragment">SQL Dumps of the used databases can also be found in that folder</li>
						</ul>
					</section>

					<section>
						<h2>Connecting (1)</h2>

						<ul>
							<li class="fragment">Connect using <code>mysqli_connect()</code></li>
							<li class="fragment">Select database using <code>mysqli_select_db()</code></li>
						</ul>
						<div class="fragment"><pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/01.php">&lt;?php

	require_once 'config.php';

	$dbhandler = @mysqli_connect(DB_HOST, DB_USER, DB_PASS)
		or die ('Could not connect to database server');
		
	// If connection succeeded, we end up here.
	// If not, the die() above gets interpreted
	echo 'Connected';
	
	// Select database &quot;fotofactory&quot;
	@mysqli_select_db($dbhandler, DB_NAME_FF)
		or die ('Could not select database');
	
	echo ' and selected the DB';
	
	// ... your query magic here

//EOF</code></pre></div>
					</section>

					<section>
						<h2>Connecting (2)</h2>

						<ul>
							<li class="fragment">Connect and selecting database in one line is possible</li>
						</ul>
						<div class="fragment"><pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/01b.php">&lt;?php

	require_once 'config.php';

	$dbhandler = @mysqli_connect(DB_HOST, DB_USER, DB_PASS, DB_NAME_FF)
		or die ('Could not connect to database server or access database');
		
	echo 'Connected and selected the DB (in one go)';
	
	// ... your query magic here

//EOF</code></pre></div>
					</section>

					<section>
						<h2>Connecting (3)</h2>

						<ul>
							<li class="fragment">
								Why store the connection in a variable?
								<ul>
									<li class="fragment">Needed to run queries on</li>
									<li class="fragment">Needed to catch errors</li>
									<li class="fragment">Needed to disconnect</li>
								</ul>
							</li>
							<li class="fragment">
								Practical use case?
								<ul>
									<li class="fragment">A setup where multiple MySQL servers are used: you write on one connection, and read from an other connection</li>
									<li class="fragment">Example: Wikipedia uses a Master-Slave MySQL setup: writes happen on the master, reads on the slaves</li>
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>Disconnecting</h2>

						<ul>
							<li class="fragment">use <code>mysqli_close()</code></li>
						</ul>
						<div class="fragment"><pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/01c.php">&lt;?php

	require_once 'config.php';

	$dbhandler = @mysqli_connect(DB_HOST, DB_USER, DB_PASS, DB_NAME_FF)
		or die ('Could not connect to database server or access database');
		
	echo 'Connected and selected the DB (in one go)';
	
	// ... your query magic here
	
	@mysqli_close($dbhandler);

//EOF</code></pre></div>
						<footer class="fragment">Note: If you don't, the connection gets closed automatically when the script has finished</footer>
					</section>

				</section>




				<section>

					<section>
						<h2>Catching Errors</h2>
					</section>

					<section>
						<h2>Let's break things</h2>

						<ul>
							<li class="fragment">PHP will tell you if something went wrong</li>
						</ul>

						<div class="fragment">

							<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/02.php">&lt;?php

	require_once 'config.php';

	$dbhandler = mysqli_connect(DB_HOST, DB_USER, 'wrongpass');

//EOF</code></pre>
						
							<pre class="bigger"><code>Warning: mysqli_connect() [function.mysqli-connect]: (28000/1045): Access denied for user 'root'@'localhost' (using password: YES) in /Users/bramus/Dropbox/Kaho/../assets/07/examples/02.php on line 5</code></pre>
						</div>
					</section>

					<section>
						<h2>Showing errors on screen</h2>
						<ul>
							<li class="fragment">
								Is a huge security issue!
								<ul>
									<li class="fragment">Users can get a glimpse of your DB layout</li>
									<li class="fragment">Users know the physical location of your website</li>
								</ul>
							</li>
						</ul>
						<div class="fragment"><figure class="zoomable-20"><img src="assets/07/tomorrowland.jpg" alt="" title="" width="400" /><figcaption>Example: Tomorrowland website</figcaption></figure></div>
					</section>

					<section>
						<h2>Catching Errors</h2>
						<ul>
							<li class="fragment">
								Suppress errors with <code>@</code> and catch 'm yourself

								<div class="fragment">

							<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/02b.php">&lt;?php

	require_once 'config.php';

	$dbhandler = @mysqli_connect(DB_HOST, DB_USER, 'wrongpass', DB_NAME_FF)
		or die ('Could not connect to database server or access database');

//EOF</code></pre>
						
							<pre class="bigger"><code>Could not connect to database server or access database</code></pre>
						</div>

							</li>
							<li class="fragment">
								Safer, as we don't expose our DB credentials to potential hackers anymore
							</li>
						</ul>
					</section>

					<section>
						<h2>Userfriendly error messages</h2>
						<ul>
							<li class="fragment">
								Better is to show the user a user-friendly error message, in a nice layout

								<div class="fragment">

									<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/02c.php">&lt;?php

	function showDbError($type) {
		header('location: error.php?type=db&amp;detail=' . $type);
		exit();
	}

	require_once 'config.php';

	$dbhandler = @mysqli_connect(DB_HOST, DB_USER, 'wrongpass', DB_NAME_FF)
		or showDbError('connect');

//EOF</code></pre>

								</div>

							</li>
							<li class="fragment">
								The referrenced error page will show a proper error message based on the <code>$_GET</code> parameters, in the layout of the website
							</li>
					</section>

					<section>
						<h2>Logging errors</h2>
						<ul>
							<li class="fragment">
								As a developer I'm not interested in a userfriendly error message, I want to see the actual error
								<ul class="fragment">
									<li>Use <code>mysqli_connect_error()</code> to get the error while connecting</li>
									<li>Use <code>mysqli_error()</code> to get all other errors</li>
								</ul>
							</li>
							<li class="fragment">
								Log the errors in <code>showDbError()</code> before jumping to the error page

								<div class="fragment">

									<pre class="bigger"><code class="language-php">&lt;?php

	function showDbError($type) {
		// @TODO: Log errors to a file
		header('location: error.php?type=db&amp;detail=' . $type);
		exit();
	}

	// ...</code></pre>

								</div>

							</li>
					</section>

					<section>
						<h2>Course Convention</h2>
						<ul>
							<li class="fragment">
								Never ever show errors on screen on a published site
								<ul class="fragment">
									<li>Log them for the developer</li>
									<li>Present the user a userfriendly error message, in an understandable language and prerably in the layout of the site</li>
								</ul>
							</li>
					</section>

				</section>




				<section>

					<section>
						<h2>Executing Queries</h2>
					</section>

					<section>
						<h2>Executing Queries</h2>

						<ul>
							<li class="fragment">Via <code>mysqli_query()</code></li>
							<li class="fragment">
								Parameters
								<ul>
									<li>The connection <code>$dbhandler</code></li>
									<li>An SQL <code>$query</code></li>
								</ul>
							</li>
							<li class="fragment">
								Example
								<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/03.php">&lt;?php

	$dbhandler = @mysqli_connect(DB_HOST, DB_USER, DB_PASS, DB_NAME_FF);
	
	$query = 'SELECT id, name FROM collections WHERE user_id = 2';
	
	$result = @mysqli_query($dbhandler, $query);
	
	echo '&lt;p&gt;This example outputs nothing&lt;/p&gt;';
	
	@mysqli_close($dbhandler);

//EOF</code></pre>
							</li>
						</ul>
					</section>

					<section>
						<h2>Types of Queries</h2>

						<ul>
							<li class="fragment">
								Two types of queries. Queries that:
								<ol>
									<li>Yield a resultset (e.g. <code>SELECT</code>, <code>SHOW</code>, <code>DESCRIBE</code>, <code>EXPLAIN</code>, &hellip;)</li>
									<li>Yield no resultset (e.g. <code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code>, <code>DROP</code>, &hellip;)</li>
								</ol>
							</li>
							<li class="fragment">
								Result of <code>mysqli_query()</code>
								<ul>
									<li class="fragment">
										If a query fails <em>(faulty query)</em>, PHP will return <code>false</code>
									</li>
									<li class="fragment">
										If a query succeeds, PHP will return
										<ul>
											<li>A <em>resultset</em> if the query yields a resultset</li>
											<li><code>true</code> if the query yields no resultset</li>
										</ul>
									</li>
								</ul>
							</li>
							<li class="fragment">
								The returned resultset may contain 0 rows, and the returned <code>true</code> only indicates that the query was executed
								<ul>
									<li class="fragment">Based on the type of query you'll need to post-process it to get the actual rows or to see what was changed/inserted
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>Processing a returned resultset</h2>

						<ul>
							<li class="fragment">
								Extra fetch function is needed to iterate the resultset
							</li>
							<li class="fragment">
								Four possible functions to walk the result
								<ol>
									<li><code>mysqli_fetch_row()</code> &mdash; fetches the current row as a <strong>numeric array</strong> and moves the pointer forward</li>
									<li><code>mysqli_fetch_assoc()</code> &mdash; fetches the current row as <strong>an associative array</strong> and moves the pointer forward</li>
									<li><code>mysqli_fetch_array()</code> &mdash; fetches the current row as both a <strong>numeric array</strong> and <strong>an associative array</strong> and moves the pointer forward</li>
									<li><code>mysqli_fetch_object()</code> &mdash; fetches the current row as an <strong>object</strong> and moves the pointer forward</li>
								</ol>
							</li>
							<li class="fragment">
								Use <code>mysqli_num_rows()</code> to get to know the number of rows returned
							</li>
						</ul>
					</section>

					<section>
						<h2>mysqli_fetch_row() example</h2>

						<div>
							<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/03b.php">&lt;?php

	$dbhandler = @mysqli_connect(DB_HOST, DB_USER, DB_PASS, DB_NAME_FF);
		
	$query = 'SELECT id, name FROM collections WHERE user_id = 2';
		
	$result = @mysqli_query($dbhandler, $query);
	
	if ($result !== false) { // Yes, we have one or more rows returned
		
		echo '&lt;p&gt;Got ' . mysqli_num_rows($result) . ' rows returned:&lt;/p&gt;';
		
		while ($row = mysqli_fetch_row($result)) {
			// Outputs &lt;p&gt;id - name&lt;/p&gt;
			echo '&lt;p&gt;' . $row[0] . '-' . $row[1] . '&lt;/p&gt;';
		}
		
	}
	
	@mysqli_close($dbhandler);</code></pre>
						</div>
					</section>

					<section>
						<h2>mysqli_fetch_assoc() example</h2>

						<div>
							<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/03c.php">&lt;?php

	$dbhandler = @mysqli_connect(DB_HOST, DB_USER, DB_PASS, DB_NAME_FF);
		
	$query = 'SELECT id, name FROM collections WHERE user_id = 2';
		
	$result = @mysqli_query($dbhandler, $query);
	
	if ($result !== false) { // Yes, we have one or more rows returned
		
		echo '&lt;p&gt;Got ' . mysqli_num_rows($result) . ' rows returned:&lt;/p&gt;';
		
		while ($row = mysqli_fetch_row($result)) {
			// Outputs &lt;p&gt;id - name&lt;/p&gt;
			echo '&lt;p&gt;' . $row['id'] . '-' . $row['name'] . '&lt;/p&gt;';
		}
		
	}
	
	@mysqli_close($dbhandler);</code></pre>
						</div>
					</section>

					<section>
						<h2>mysqli_fetch_object() example</h2>

						<div>
							<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/03d.php">&lt;?php

	$dbhandler = @mysqli_connect(DB_HOST, DB_USER, DB_PASS, DB_NAME_FF);
		
	$query = 'SELECT id, name FROM collections WHERE user_id = 2';
		
	$result = @mysqli_query($dbhandler, $query);
	
	if ($result !== false) { // Yes, we have one or more rows returned
		
		echo '&lt;p&gt;Got ' . mysqli_num_rows($result) . ' rows returned:&lt;/p&gt;';
		
		while ($row = mysqli_fetch_row($result)) {
			// Outputs &lt;p&gt;id - name&lt;/p&gt;
			echo '&lt;p&gt;' . $row-&gt;id . '-' . $row-&gt;name . '&lt;/p&gt;';
		}
		
	}
	
	@mysqli_close($dbhandler);</code></pre>
						</div>
					</section>

					<section>
						<h2>What to choose</h2>

						<ul>
							<li class="fragment">
								Preference goes to <code>mysqli_fetch_assoc()</code>
								<ul>
									<li class="fragment">
										Result is more readable than <code>mysqli_fetch_row()</code>
										<ul>
											<li><code>$row[1]</code> vs. <code>$row['name']</code></li>
										</ul>
									</li>
									<li class="fragment">
										Faster than <code>mysqli_fetch_array()</code>
										<ul>
											<li>At 1000 selects <code>mysqli_fetch_assoc()</code> is 10% faster</li>
										</ul>
									</li>
									<li class="fragment">
										Code easily adjustable when query changes
										<ul>
											<li>If you select an extra field, you don't need to chang the indices in <code>$row</code></li>
											<li><code>$row[1]</code> might need to change to <code>$row[2]</code> where <code>$row['name']</code> remains unchanged</li>
										</ul>
									</li>
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>Processing a query with no resultset</h2>

						<ul>
							<li class="fragment">
								Extra functions are needed to get extra information
								<ul>
									<li class="fragment">Use <code>mysqli_affected_rows()</code> to get to know how many rows were affected by the query</li>
									<li class="fragment">Use <code>mysqli_insert_id()</code> to get the know the last auto_increment value</li>
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>mysqli_affected_rows() example</h2>

						<div>
							<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/03e.php">&lt;?php

	$dbhandler = @mysqli_connect(DB_HOST, DB_USER, DB_PASS, DB_NAME_FF);
		
	$query = 'UPDATE collections SET user_id = ROUND(RAND()*10) WHERE id != 2';
		
	$result = @mysqli_query($dbhandler, $query);
	
	if ($result !== false) { // Yes, we have one or more rows returned
		
		echo '&lt;p&gt;' . mysqli_affected_rows($dbhandler) . ' were affected&lt;/p&gt;';
		
	}
	
	@mysqli_close($dbhandler);</code></pre>
						</div>
					</section>

					<section>
						<h2>mysqli_insert_id() example</h2>

						<div>
							<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/03f.php">&lt;?php

	$dbhandler = @mysqli_connect(DB_HOST, DB_USER, DB_PASS, DB_NAME_FF);
		
	$query = 'INSERT INTO collections (name, user_id) VALUES ("TestColl", 2)';
		
	$result = @mysqli_query($dbhandler, $query);
	
	if ($result !== false) { // Yes, we have one or more rows returned
		
		echo '&lt;p&gt;Row inserted with ID' . mysqli_insert_id($dbhandler) . '&lt;/p&gt;';
		
	}
	
	@mysqli_close($dbhandler);</code></pre>
						</div>
					</section>

					<section>
						<h2>Free up memory with mysqli_free_result()</h2>

						<div>
							<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/03g.php">&lt;?php

	$dbhandler = @mysqli_connect(DB_HOST, DB_USER, DB_PASS, DB_NAME_FF);
		
	$query = 'SELECT id, name FROM collections WHERE user_id = 2';
		
	$result = @mysqli_query($dbhandler, $query);
	
	if ($result !== false) { // Yes, we have one or more rows returned
		
		// &hellip; process rows here
		
	}
	
	// Free up some memory (and tell how much memory is used before and after)
	echo memory_get_usage() . PHP_EOL;
	mysqli_free_result($result);
	echo memory_get_usage() . PHP_EOL;
	
	// &hellip; your other code here
	
	@mysqli_close($dbhandler);</code></pre>
						</div>
					</section>

				</section>




				<section>

					<section>
						<h2>Securing Queries</h2>
					</section>

				</section>




				<section>

					<section>
						<h2>Best Practices</h2>
					</section>


					<section>
						<h2>Best Practices?</h2>

						<ul>
							<li class="fragment">
								A set of often used methods / tips to help you working with databases
								<ol>
									<li class="fragment">Working with dates and time</li>
									<li class="fragment">Use of <code>sprintf()</code> / prepared statements</li>
									<li class="fragment">Joins over loops</li>
									<li class="fragment">Passwords</li>
								</ol>
							</li>
						</ul>
					</section>

					<section>
						<h2>Best Practice #1<br /><br />Working with dates and time</h2>
					</section>


					<section>
						<h2>Dates in PHP</h2>

						<ul>
							<li class="fragment">
								Current timestamp accessible with <code>time()</code>
							</li>
							<li class="fragment">
								Convert a timestamp to a readable format with <code>date()</code>
								<ul>
									<li class="fragment">
										Examples
										<pre class="bigger"><code class="language-php">date('Y-m-d H:i:s', $someDate); // 1983-05-26 23:45:00
date('j/n/y h:i:s A', $someDate); // 26/5/83 11:45:00 PM
date('D, F d, Y', $someDate); // Thu, May 26, 1983</code></pre>
									</li>
									<li class="fragment">If no timestamp is given, the current time is taken</li>
								</ul>
							</li>
							<li class="fragment">
								Convert a datestring to a timestamp with <code>strtotime()</code>
								<ul>
									<li class="fragment">Does not only accept fixed dates such as <code>26/12/1983</code> but also accepts relative dates such as <code>tomorrow</code>, <code>+1 week</code>,  <code>next monday</code>, etc.</li>
								</ul>
							</li>
						</ul>
					</section>


					<section>
						<h2>Dates in MySQL</h2>

						<ul>
							<li class="fragment">
								Current timestamp accessible with <code>NOW()</code>
							</li>
							<li class="fragment">
								From timestamp to a readable format with <code>date_format()</code>
								<ul>
									<li class="fragment">
										Example
										<pre class="bigger"><code class="language-php">SELECT date_format(&quot;%Y-%m-%d&quot;, publishTimestamp) AS readabledate FROM ...</code></pre>
									</li>
									<li class="fragment">Most format directives the same as in PHP but with leading <code>%</code></li>
									<li class="fragment">See <a href="http://dev.mysql.com/doc/refman/5.1/en/date-and-time-functions.html #function_date-format">mysql docs</a> for more info</li>
								</ul>
							</li>
							<li class="fragment">
								From datestring to timestamp with <code>unix_timestamp()</code>
								<ul>
									<li class="fragment">
										Example
										<pre class="bigger"><code class="language-php">SELECT unix_timestamp(publishDateTime) AS timestamp FROM ...</code></pre>
									</li>
								</ul>
							</li>
						</ul>
					</section>


					<section>
						<h2>Date &amp; time best practices (1)</h2>

						<ul>
							<li class="fragment">
								Never combine PHP and MySQL time
								<ul class="fragment">
									<li>Funky situations where mysql server clock is ahead of webserver</li>
									<li>Our choice: let webserver (thus PHP) decide what time it is</li>
								</ul>
							</li>
							<li class="fragment">
								Store dates in a readable format in your database
								<ul>
									<li class="fragment">
										Timestamps are not that readable when looking at raw dumps
									</li>
									<li class="fragment">
										Use <code>datetime</code> as the field type
										<ul>
											<li>Beware: does not contain timezone information!</li>
										</ul>
									</li>
								</ul>
							</li>
							<li class="fragment">
								Convert dates in PHP, not in your queries (unless necessary)
								<ul>
									<li class="fragment">
										Prevents complex queries
									</li>
									<li class="fragment">
										Examples
										<ul>
											<li>When storing dates: <code>$data['publish_date'] = date('Y-m-d H:i:s');</code></li>
											<li>When displaying (parts of) dates: <code>$month = date('m', strtottime($dbResult['publish_date']));</code></li>
										</ul>
									</li>
								</ul>
							</li>
						</ul>
					</section>


					<section>
						<h2>Date &amp; time best practices (2)</h2>
						<ul>
							<li class="fragment">
								Don't be too specific when retrieving items after/before a given date
								<pre class="bigger"><code class="language-php">$result = @mysqli_query($dbhandler, 'SELECT * FROM blogposts WHERE publish_date &gt; &quot;'. date('Y-m-d H:i:s'). '&quot;') or showDbError('query');</code></pre>
								<ul>
									<li>Very specific example</li>
								</ul>
							</li>
							<li class="fragment">Reason: MySQL Query Cache</li>
							<li class="fragment">Fix: Round your dates to the minute or 5 minutes if the script allows it</li>
						</ul>
					</section>

					<section>
						<h2>Best Practice #2<br /><br />Use sprintf()<br />or<br />prepared statements</h2>
					</section>


					<section>
						<h2>The why and how of sprintf()</h2>

						<ul>
							<li class="fragment">
								Cast query parameters to their proper type
								<ul>
									<li>If you expect an integer, you must cast it to being one</li>
								</ul>
							</li>
							<li class="fragment">
								When using <code>sprintf()</code> the parameter will be casted automatically
								<ul>
									<li><code>sprintf()</code> allows you to tuck strings into another, in a certain type</li>
									<li>Usage: <code>sprintf($stringWithDirectives, $param1, $param 2, &hellip;)</code></li>
								</ul>
							</li>
							<li class="fragment">
								Bonus advantages of <code>sprintf()</code>
								<ul>
									<li>Code is less prone to syntax errors</li>
									<li>Code is more readable</li>
								</ul>
							</li>
							<li class="fragment">
								Better <small style="vertical-align: baseline;">(but not mandatory for this course)</small>: Prepared Statements
								<ul>
									<li>Added bonus: Automatically protects you against SQL Injection</li>
								</ul>
							</li>
						</ul>
					</section>


					<section>
						<h2>Sprintf example (1)</h2>

						<ul>
							<li class="fragment">
								Sans <code>sprintf()</code>
								<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/04.php">$name = 'bramus';
$status = 'Just received the trophy &quot;Marksman of the year&quot;';
$date = time();

$query 	= 'INSERT INTO statuses (name, status, datum) '
. 'VALUES ('
. '&quot;' . 	mysqli_real_escape_string($dbhandler, $name) . '&quot;, '
. '&quot;' . 	mysqli_real_escape_string($dbhandler, $status) . '&quot;, '
. 'FROM_UNIXTIME(' . mysqli_real_escape_string($dbhandler, $date) . ')'
.')';

@mysqli_query($dbhandler, $query) or showDbError('query');

$query = 'SELECT * FROM statuses '
. 'WHERE name = &quot;' . mysqli_real_escape_string($dbhandler,  $name) . '&quot;'
. 'AND datum &lt;= FROM_UNIXTIME(' . mysqli_real_escape_string($dbhandler,  $date) . ')'
.' ORDER BY id DESC';

// ...</code></pre>
							</li>
						</ul>
					</section>


					<section>
						<h2>Sprintf example (2)</h2>

						<ul>
							<li class="fragment">
								With <code>sprintf()</code>
								<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/04b.php">$name = 'bramus';
$status = 'Just received the trophy &quot;Marksman of the year&quot;';
$date = time();

$query 	= sprintf('INSERT INTO statuses (name, status, datum) VALUES ("%s", "%s", FROM_UNIXTIME(%d))', 
	mysqli_real_escape_string($dbhandler, $name),
	mysqli_real_escape_string($dbhandler, $status),
	mysqli_real_escape_string($dbhandler, (int) $datetime)
);

@mysqli_query($dbhandler, $query) or showDbError('query');

$query = sprintf('SELECT * FROM statuses WHERE name = "%s" AND datum <= FROM_UNIXTIME(%d) ORDER BY id DESC',
	mysqli_real_escape_string($dbhandler, $name),
	mysqli_real_escape_string($dbhandler, (int) $datetime)
);

// ...</code></pre>
							</li>
						</ul>
					</section>


					<section>
						<h2>sprintf directives</h2>

						<ul>
							<li class="fragment">
								Only 3 importants ones
								<ul>
									<li><code>%s</code> &mdash; string</li>
									<li><code>%d</code> &mdash; integer</li>
									<li><code>%f</code> &mdash; float</li>
								</ul>
							</li>
							<li class="fragment">
								Full directive reference: <a href="http://php.net/sprintf">http://php.net/sprintf</a>
							</li>
						</ul>
					</section>


					<section>
						<h2>Prepared Statement example</h2>

						<div>
							<pre class="bigger"><code class="language-php" data-overlay-example="assets/07/examples/04c.php">$name = 'bramus';
$status = 'Just received the trophy &quot;Marksman of the year&quot;';
$date = time();

$query 	= @mysqli_prepare($dbhandler, 'INSERT INTO statuses (name, status, datum) VALUES (?, ?, FROM_UNIXTIME(?))');
@mysqli_stmt_bind_param($query, 'ssi', $name, $status, $datetime);

@mysqli_stmt_execute($query) or showDbError('query');
@mysqli_stmt_close($query);

$query 	= mysqli_prepare($dbhandler, 'SELECT * FROM statuses WHERE name = ? AND datum &lt;= FROM_UNIXTIME(?) ORDER BY id DESC');
@mysqli_stmt_bind_param($query, 'si', $name, $datetime);
	
@mysqli_stmt_execute($query) or showDbError('query');
@mysqli_stmt_bind_result($query, $r_id, $r_name, $r_status, $r_datum);
@mysqli_stmt_store_result($query);

echo '&lt;p&gt;Got ' . mysqli_stmt_num_rows($query) . ' rows:&lt;/p&gt;';

while ($row = mysqli_stmt_fetch($query)) {
	echo '&lt;p&gt;' . $r_id . ' - ' . $r_name . ' - ' . 
		 date('d/m/Y H:i:s', strtotime($r_datum)) . ': ' . $r_status . '&lt;/p&gt;';
}	

@mysqli_stmt_close($query);</code></pre>
						</div>
					</section>

					<section>
						<h2>Best Practice #3<br /><br />Joins over loops</h2>
					</section>


					<section>
						<h2>Example</h2>

						<ul>
							<li class="fragment">
								Detailpage of a blogpost
								<ul>
									<li>Shows blogpost</li>
									<li>Allow comments on blogpost</li>
									<li>Authorinformation stored separately in database</li>
								</ul>
							</li>
						</ul>
					</section>


					<section>
						<h2>Bad execution</h2>

						<ul>
							<li class="fragment">
								Execute queries inside a loop
								<pre class="bigger"><code class="language-php">$id = (int) isset($_GET['id']) ? $_GET['id'] : 0;
$dbHandler = &hellip;;

$blog = 'SELECT id, title, content FROM blogs WHERE id = &quot;' . $id . '&quot;';

// &hellip; fetch and show blogpost

$comments = 'SELECT id, blog_id, comment, publishdate, author_id 
FROM comments WHERE blog_id = &quot;' . $id . '&quot;';

// &hellip; fetch comments into array

foreach ($comments as $c) {

	$authorInfo = 'SELECT * FROM authors WHERE id = &quot;' . $c['author_id'] . '&quot;';

	// &hellip; show comment + author info 

}</code></pre>
								<ul>
									<li>
										With 50 comments, 52 queries are executed
										<ul>
											<li>1 x get blogpost, 1 x get comments, 50 x get authorinfo</li>
										</ul>
								</ul>
							</li>
						</ul>
					</section>


					<section>
						<h2>Proper execution</h2>

						<ul>
							<li class="fragment">
								Use a database JOIN to minimize the number of executed queries
								<pre class="bigger"><code class="language-php">$id = (int) isset($_GET['id']) ? $_GET['id'] : 0;
$dbHandler = &hellip;;

$blog = 'SELECT id, title, content FROM blogs WHERE id = &quot;' . $id . '&quot;';

// &hellip; fetch and show blogpost

$comments = 'SELECT c.id, c.blog_id, c.comment, c.publishdate, c.author_id, a.name, a.email, a.url FROM comments AS c INNER JOIN authors AS a ON c.author_id = a.id WHERE c.blog_id = &quot;' . $id . '&quot;';

// &hellip; fetch comments into array

foreach ($comments as $c) {

	// &hellip; show comment + author info 

}</code></pre>
								<ul>
									<li>
										With 50 comments, 2 queries are executed
										<ul>
											<li>1 x get blogpost, 1 x get comments with authorinfo</li>
										</ul>
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>Best Practice #4<br /><br />Encrypt passwords</h2>
					</section>


					<section>
						<h2>Encrypt passwords</h2>

						<ul>
							<li class="fragment">
								Never store passwords as plaintext but encrypt them
								<ul>
									<li>If you don't, it's very easy for a hacker to steal lots of passwords</li>
								</ul>
							</li>
							<li class="fragment">
								Basic encryption: Use <code>md5()</code> or <code>sha1()</code>
								<ul>
									<li>
										Problem: encryption is always the same
										<ul>
											<li>e.g. <code>md5('test')</code> is always <code>098f6bcd4621d373cade4e832627b4f6</code></li>
											<li>Can easily be decrypted, or searched for with Google! (see <a href="https://github.com/juuso/BozoCrack">BozoCrack</a>)</li>
										</ul>
									</li>
									<li>
										Fix: add an extra <em>salt</em> (a secret, long, and complex string) to the string before encrypting
									</li>
								</ul>
							</li>
							<li class="fragment">
								Better encryption: Use <code>crypt()</code> or <code>hash()</code>
								<ul>
									<li>
										Unlike the methods above, the salt can be different per encrypted password
									</li>
								</ul>
							</li>
							<li class="fragment">To validate a password, encrypt it and compare it to the stored hash</li>
						</ul>
					</section>

				</section>




				<section>

					<section>
						<h2>And now?</h2>
					</section>


					<section>
						<h2>Now: Practice!</h2>
						<ul>
							<li class="fragment">See lab assignment</li>
						</ul>
					</section>

					<section>
						<h2>Advanced Webscripting: DBAL</h2>
						<ul>
							<li class="fragment">
								Later on we'll evolve towards a Database Access Layer
								<ul>
									<li class="fragment">
										Class that handles most for us, including the basic CRUD actions
										<ul class="fragment">
											<li>CRUD = Create, Read, Update, Delete</li>
											<li>Some specific functions such as <code>getNumRows()</code>, <code>getPairsAsArray()</code></li>
											<li>What this means to us: Write less queries!</li>
										</ul>
									</li>
									<li class="fragment">
										Depending on the type of query, we'll get a different result
										<ul class="fragment">
											<li><code>SELECT</code>: Resultset, as an array</li>
											<li><code>INSERT</code>: The inserted ID</li>
											<li><code>UPDATE</code>/<code>DELETE</code>: The number of affected rows</li>
										</ul>
									</li>
									<li class="fragment">
										Debugging, error handling, and code performance
										<ul class="fragment">
											<li>Keep track of executed queries</li>
											<li>Use of exceptions</li>
											<li>Singleton Pattern</li>
										</ul>
									</li>
								</ul>
							</li>
						</ul>
					</section>

				</section>




				<section>

					<section>
						<h2>Extra: PhpMyAdmin</h2>
					</section>

					<section>
						<h2>Demo time!</h2>

						<figure><img src="assets/07/phpmyadmin.png" alt="" title="" width="600" /></figure>

					</section>

					<section>
						<h2>Demo Recap</h2>

						<ul>
							<li class="fragment">Import/Export databases</li>
							<li class="fragment">Create tables</li>
							<li class="fragment">Insert/Update data</li>
							<li class="fragment">Run Queries</li>
							<li class="fragment">Add users and set privileges</li>
						</ul>
						
					</section>

				</section>




				<section>

					<section>
						<h2>Want more?</h2>
					</section>

					<section>
						<h2 style="font-size: 180%">There's always room for improvement</h2>

						<ul>
							<li class="fragment">
								Learn to work with the OO based version of <code>mysqli</code>
							</li>
							<li class="fragment">
								Use <a href="http://mattbango.com/notebook/web-development/prepared-statements-in-php-and-mysqli/">Prepared Statements with <code>mysqli</code></a>
								<ul>
									<li>If used properly this will automatically protect against SQL Injection</li>
								</ul>
							</li>
							<li class="fragment">
								<a href="http://www.kitebird.com/articles/php-pdo.html">Learn to work with <code>pdo_mysql</code></a>
								<ul>
									<li>Don't forget to call <code>$dbh->setAttribute(PDO::ATTR_EMULATE_PREPARES, false);</code> to make sure your prepared statements are real <em>(<a href="http://stackoverflow.com/a/60496">source</a>)</em></li>
								</ul>
							</li>
							<li class="fragment">
								Use a Database Abstraction Layer (DAL), or take it a step further and use an Object Relational Mapper (ORM)
								<ul>
									<li>Example: <a href="http://www.doctrine-project.org/">Doctrine</a></li>
								</ul>
							</li>
						</ul>
					</section>

				</section>

				<!-- The END -->
				<section>
					<section>
						<h2>Questions?</h2>
						<footer>
							<em><a href="http://www.ikdoeict.be/">ikdoeict.be</a> &mdash; <a href="mailto:bramus.vandamme@kahosl.be">bramus.vandamme@kahosl.be</a></em>
						</footer>
					</section>
				</section>



				<!-- Sources -->
				<section id="sources">
					<section>
						<h2>Sources</h2>
						<ul>
							
						</ul>
					</section>
				</section>
				
			</div>

			<!-- The navigational controls UI -->
			<aside class="controls">
				<a class="left" href="#">&#x25C4;</a>
				<a class="right" href="#">&#x25BA;</a>
				<a class="up" href="#">&#x25B2;</a>
				<a class="down" href="#">&#x25BC;</a>
				<span id="revealIndex">/</span>
			</aside>
			
			<!-- Index Link -->
			<aside class="back">
				<a href="index.html">&larr; Back to index</a>
			</aside>

			<!-- ikdoeict.be Link -->
			<a href="http://www.ikdoeict.be/" title="ikdoeict.be" id="ikdoeict">ikdoeict.be</a>
			
			<!-- Displays presentation progress, max value changes via JS to reflect # of slides -->
			<div class="progress"><span></span></div>
			
		</div>
		
		<script src="js/reveal.js"></script>
		<script src="lib/highlight.js"></script>
		<script src="lib/prefixfree.js"></script>
		<script src="lib/css-snippets.js"></script>
		<script src="lib/css-edit.js"></script>
		<script src="lib/incrementable.js"></script>
		<script src="js/main.js"></script>

	</body>
</html>